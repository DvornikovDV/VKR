# План Реализации Виджетов по Итерациям

**Версия**: 1.0  
**Дата**: 28.01.2026  
**Источник**: Извлечено из `doc/widgets-dev-guide.md` (раздел 7)  
**Фокус**: Только план реализации по итерациям с выполненными пунктами  

---

## Итерация 1: Основы Display виджетов (3 дня)

**Цель:** Первые Display типы (вывод только, без ввода)

**Виджеты в этой итерации:**
- ✅ number-display
- ✅ text-display
- ✅ led
- ✅ gauge (удален из меню, но реализован в коде)

**Ветка:** `feature/widgets-phase1-display`  
**Статус:** ✅ ЗАВЕРШЕНА

### Задачи

- [x] Создать `WidgetManager` класс - **реализовано**
- [x] Реализовать `create()` - создание виджета - **реализовано**
- [x] Реализовать `delete()` - удаление виджета - **реализовано**
- [x] Базовая Konva визуализация для каждого типа - **реализовано**
- [x] Привязать контекстное меню к ImageManager (только эти 4 типа) - **реализовано** (gauge убран из меню)
- [x] Базовая панель свойств (позиция, размер, оформление) - **реализовано**
- [x] Тестирование: создать по одному каждому типу - **проведено**

### Результаты

- ✅ 4 Display типа видны на экране (LED, Number Display, Text Display, Gauge)
- ✅ Контекстное меню работает (3 типа: number-display, text-display, led)
- ✅ Виджеты удаляются
- ✅ Панель свойств показывает данные
- ✅ Виджеты выбираются и выделяются
- ✅ Позиция и размер отображаются в панели свойств

### Реализованные файлы

- ✅ `public/widget-manager.js` - создан (~400 строк)
- ✅ `public/widget-types.js` - создан (определение типов и дефолтов)
- ✅ `public/context-menu.js` - создан (переиспользуемое меню)
- ✅ `public/image-manager.js` - обновлен (интеграция меню)
- ✅ `public/properties-panel.js` - обновлен (поддержка виджетов)
- ✅ `public/selection-manager.js` - обновлен (поддержка выбора виджетов)
- ✅ `public/ui-controller.js` - обновлен (инициализация WidgetManager)

### Commits

- `bed383f`: Remove gauge widget from context menu (последний)
- (и другие коммиты в ветке)

---

## Итерация 2: Позиция, размер, выделение (2 дня)

**Цель:** Интерактивное редактирование свойств

**Статус:** ⬜ ОЖИДАЕТ РАЗРАБОТКИ

### Задачи

- [ ] Реализовать `updatePosition()` с граничными проверками
- [ ] Реализовать `updateSize()`
- [ ] Интеграция с SelectionManager (выбор виджета) - **частично, нужно расширить**
- [ ] Развёрнутая панель свойств (позиция, размер, цвет) - **нужно расширить**
- [ ] Панель обновляется при выборе виджета - **базово работает, нужно доделать**
- [ ] Перетягивание виджета внутри изображения - **нужно добавить**
- [ ] Тестирование: полный workflow выбора и редактирования

### Задача

Расширить существующие механизмы выбора и редактирования.

### Результат

- ✅ Выделение работает
- ✅ Панель свойств полностью функциональна
- ✅ Можно менять позицию и размер через панель и через drag

### Файлы для обновления

- `public/widget-manager.js` - добавить drag, граничные проверки
- `public/properties-panel.js` - расширить (полная версия с редактированием)
- `public/selection-manager.js` - доделать (обработка выбора виджетов)

---

## Итерация 3: Input виджеты (2 дня)

**Цель:** Типы для ввода данных

**Виджеты в этой итерации:**
- ⬜ number-input
- ⬜ text-input

**Статус:** ⬜ ОЖИДАЕТ РАЗРАБОТКИ

### Задачи

- [ ] Реализовать оба Input типа в Konva
- [ ] Визуализация: текстовое поле на схеме
- [ ] Интеграция HTML input внутри Konva
- [ ] Валидация на уровне класса InputWidget
- [ ] Панель свойств: параметры min/max/step для number-input
- [ ] Панель свойств: maxLength/pattern для text-input
- [ ] Добавить в контекстное меню (всего 6 типов)
- [ ] Тестирование: для каждого ввести значения, проверить граничные

### Результат

- ✅ Input типы видны на экране
- ✅ Валидация работает
- ✅ Контекстное меню имеет 6 типов

### Файлы для создания/обновления

- `public/widget-types.js` - обновить (INPUT типы)
- `public/widget-manager.js` - обновить (INPUT виджеты)
- `public/properties-panel.js` - обновить (INPUT параметры)
- `public/image-manager.js` - обновить (меню с 6 типами)

---

## Итерация 4: Control виджеты (2 дня)

**Цель:** Интерактивные управляющие компоненты

**Виджеты в этой итерации:**
- ⬜ toggle
- ⬜ button
- ⬜ slider

**Статус:** ⬜ ОЖИДАЕТ РАЗРАБОТКИ

### Задачи

- [ ] Реализовать три Control типа
- [ ] Визуализация каждого типа
- [ ] Клик/drag обработчики
- [ ] Фидбек (изменение визуального состояния при действии)
- [ ] Панель свойств: параметры для каждого типа
- [ ] Добавить в контекстное меню (всего 9 типов)
- [ ] Тестирование: интерактивность каждого типа
- [ ] Тестирование: фидбек работает

### Результат

- ✅ Все 9 типов доступны
- ✅ Control виджеты интерактивны
- ✅ Контекстное меню полное

### Файлы для создания/обновления

- `public/widget-types.js` - обновить (CONTROL типы)
- `public/widget-manager.js` - обновить (CONTROL виджеты)
- `public/properties-panel.js` - обновить (CONTROL параметры)
- `public/image-manager.js` - обновить (меню с 9 типами)

---

## Итерация 5: Синхронизация с изображениями (2 дня)

**Цель:** Виджеты движутся и масштабируются вместе с изображениями

**Статус:** ⬜ ОЖИДАЕТ РАЗРАБОТКИ

### Задачи

- [ ] Реализовать `onImageMove()` - виджеты следуют за изображением
- [ ] Реализовать `onImageResize()` - виджеты масштабируются
- [ ] Сохранять относительные координаты
- [ ] Интеграция с ImageManager
- [ ] Тестирование: переместить изображение → виджеты движутся
- [ ] Тестирование: ресайзить изображение → виджеты масштабируются
- [ ] Тестирование: удалить изображение → виджеты удаляются

### Результат

- ✅ Виджеты синхронизированы с изображениями
- ✅ При движении/ресайзе/удалении изображения виджеты обновляются

### Файлы для обновления

- `public/widget-manager.js` - обновить (синхро методы)
- `public/image-manager.js` - обновить (триггеры событий)

---

## Итерация 6: Привязка к устройствам (2 дня)

**Цель:** Связь виджетов с ID устройств и метаданными

**Статус:** ⬜ ОЖИДАЕТ РАЗРАБОТКИ

### Задачи

- [ ] Загрузить devices-registry.json (mock файл)
- [ ] Реализовать `updateBinding()`
- [ ] Выпадающий список устройств в панели свойств
- [ ] Отображение метаданных (единица, диапазон, описание, тип)
- [ ] **БЕЗ реалтайм** - только статические метаданные
- [ ] Отвязка виджета (выбрать "не привязано")
- [ ] Тестирование: привязать различные виджеты к различным устройствам
- [ ] Тестирование: метаданные отображаются правильно

### Результат

- ✅ Выпадающий список с устройствами
- ✅ Метаданные отображаются
- ✅ Привязка сохраняется в памяти

### Файлы для создания/обновления

- `public/properties-panel.js` - обновить (выпадающий список)
- `public/widget-manager.js` - обновить (bindingId)
- `public/ui-controller.js` - обновить (загрузка devices-registry)
- `backend/config/devices-registry.json` - создать (mock)

---

## Итерация 7: Интеграция и полировка (2 дня)

**Цель:** Все компоненты работают вместе, готово к save/load

**Статус:** ⬜ ОЖИДАЕТ РАЗРАБОТКИ

### Задачи

- [ ] Полное тестирование всего workflow'а (создание → редактирование → удаление)
- [ ] Edge cases (удаление изображения с виджетами, неправильные значения)
- [ ] Обработка ошибок (граничные условия, валидация)
- [ ] Визуальная полировка (иконки, цвета, шрифты, консистентность)
- [ ] Проверка памяти (нет утечек при удалении)
- [ ] Документирование кода и архитектуры
- [ ] Финальное тестирование на производительность

### Результат

- ✅ Система виджетов полностью функциональна
- ✅ Готово к разработке save/load
- ✅ Готово к backend интеграции

### Файлы

Полировка по всем файлам

---

## Таблица Статуса

| Итерация | Фокус | Дни | Виджеты | Ветка | Статус |
|----------|-------|-----|---------|-------|--------|
| 1 | Display (4 типа) | 3 | number-display, text-display, led, gauge | `feature/widgets-phase1-display` | ✅ ЗАВЕРШЕНА |
| 2 | Позиция, размер, выделение | 2 | (все) | `feature/widgets-phase2-selection` | ⬜ TODO |
| 3 | Input (2 типа) | 2 | number-input, text-input | `feature/widgets-phase3-input` | ⬜ TODO |
| 4 | Control (3 типа) | 2 | toggle, button, slider | `feature/widgets-phase4-control` | ⬜ TODO |
| 5 | Синхро с изображениями | 2 | (все) | `feature/widgets-phase5-sync` | ⬜ TODO |
| 6 | Привязка к устройствам | 2 | (все) | `feature/widgets-phase6-binding` | ⬜ TODO |
| 7 | Интеграция и полировка | 2 | (все) | `feature/widgets-phase7-integration` | ⬜ TODO |
| **ИТОГО** | **Виджеты готовы** | **15** | **9 типов** | **main** | ⬜ TODO |

---

## Архитектура по Итерациям

### Фазы разработки

**Фаза 1: Виджеты (Итерации 1-7, текущая фаза)**
- Система создания, редактирования, удаления виджетов
- 9 типов: 4 Display + 2 Input + 3 Control
- Привязка к устройствам (памяти)

**Фаза 2: Save/Load (будущее)**
- Сохранение schema.json + bindings.json
- Загрузка проектов

**Фаза 3: Backend (будущее)**
- MQTT интеграция
- WebSocket для реалтайм
- REST API

**Фаза 4: Dashboard (будущее)**
- Оператор видит live данные
- Реалтайм обновления

---

## Стратегия Ветвления

Каждая итерация = отдельная ветка:

```
main
├── feature/widgets-phase1-display     (✅ ЗАВЕРШЕНА)
├── feature/widgets-phase2-selection   (текущая разработка)
├── feature/widgets-phase3-input
├── feature/widgets-phase4-control
├── feature/widgets-phase5-sync
├── feature/widgets-phase6-binding
└── feature/widgets-phase7-integration
```

Каждая ветка:
- Создается из `main`
- Разрабатывается независимо
- Имеет свой PR
- Мергится в `main` после завершения

---

## Примечания

1. **Итерация 1 завершена** - Display виджеты (LED, Number Display, Text Display) полностью работают
2. **Gauge удален из меню** - но реализован в коде для будущих итераций
3. **SelectionManager обновлен** - поддерживает выбор виджетов
4. **PropertiesPanel обновлена** - показывает свойства виджетов
5. **ContextMenu добавлено** - для быстрого создания виджетов

---

## Следующие Шаги

1. **Merge Iteration 1** (когда готово) - `feature/widgets-phase1-display` → `main`
2. **Start Iteration 2** - работать с `feature/widgets-phase2-selection`
3. **Повторить для каждой итерации** - по одной в ветке
4. **После Iteration 7** - Merge всех в `main` → система готова

---

**Эта документация регулярно обновляется по мере разработки.**
