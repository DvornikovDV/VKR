# ПЛАН РАЗРАБОТКИ: ВИДЖЕТЫ ФАЗА 1 (Phase 1 Display)

**Версия**: 1.0  
**Статус**: АКТИВНАЯ РАЗРАБОТКА  
**Дата начала**: 2026-01-24  
**Целевая дата завершения**: 2026-02-07  
**Приоритет**: ВЫСОКИЙ

---

## ЦЕЛЬ ИТЕРАЦИИ

Реализовать базовую систему отображения виджетов на канвасе с синхронизацией позиций с изображениями и точками соединения.

**Требования**:
- Каждое изображение имеет свой набор виджетов
- Виджеты отслеживают положение изображения
- Виджеты обновляются при ресайзе
- Система тестирована и готова к расширению

---

## АРХИТЕКТУРА

```
UIController (координатор)
    ↓
WidgetManager (управление всеми виджетами)
    ├─ Управление жизненным циклом виджетов
    ├─ Синхронизация позиций
    ├─ Обработка событий от изображений
    └─ Связь с ImageManager
    ↓
Widget (отдельный виджет)
    ├─ Информация о типе (info/warning/error/custom)
    ├─ Позиция и размер
    ├─ Содержимое (текст/HTML)
    ├─ Привязка к точке/стороне изображения
    └─ Обновление при изменении хозяина
    ↓
Konva.Shape (отрисовка на канвасе)
```

---

## ЭТАПЫ И ЗАДАЧИ

### ЭТАП 1: Инфраструктура и синхронизация

Цель: Обеспечить корректную синхронизацию между изображениями и виджетами.

#### Задача 1.1: Исправить race condition инициализации
**Статус**: ✓ ЗАВЕРШЕНО
**Коммиты**: 77a1418, 06df590
**Файлы**:
- `public/canvas-manager.js` - добавлены Promise методы
- `public/ui-controller.js` - async init() и await

**Подзадачи**:
- [x] Добавить `ready()` метод в CanvasManager
- [x] Сделать UIController.init() async
- [x] Добавить null-checks в setupEventListeners()

---

#### Задача 1.2: Реализовать WidgetManager
**Статус**: В РАЗРАБОТКЕ
**Файлы**:
- `public/widget-manager.js` - основной класс (СОЗДАТЬ)
- `public/ui-controller.js` - интеграция WidgetManager

**Подзадачи**:
- [ ] Создать класс WidgetManager с конструктором
- [ ] Реализовать методы инициализации
- [ ] Реализовать методы отслеживания изображений
- [ ] Интегрировать в UIController.init()
- [ ] Проверить что конструктор не вызывает ошибок

**Ключевые методы**:
```javascript
constructor(layer, imageManager, canvasManager)
onImageAdded(imageId, imageData)
onImageRemoved(imageId)
onImageResize(imageId, width, height)
onImageMove(imageId, x, y)
getWidgets(imageId)  // вернуть виджеты для изображения
```

**Требования**:
- Использовать Map для хранения виджетов по imageId
- Слушать события от imageManager
- Обновлять позиции всех виджетов в реальном времени

---

#### Задача 1.3: Реализовать Widget класс
**Статус**: ПЛАНИРОВАНИЕ
**Файлы**:
- `public/widget.js` - класс Widget (СОЗДАТЬ)
- `public/widget-manager.js` - использует Widget

**Подзадачи**:
- [ ] Создать класс Widget с конструктором
- [ ] Реализовать методы позиционирования
- [ ] Реализовать методы обновления содержимого
- [ ] Добавить методы жизненного цикла
- [ ] Интегрировать в WidgetManager

**Ключевые методы**:
```javascript
constructor(config) // { id, type, content, attachTo, layer }
update(imageData)  // обновить позицию
destroy()  // удалить с канваса
getBounds()  // получить границы
setContent(content)  // обновить содержимое
```

**Требования**:
- Типы виджетов: info, warning, error, custom
- Привязка: к точке соединения ИЛИ к стороне изображения
- Автоматический скрытие если выходит за границы
- Следование за изображением при движении

---

### ЭТАП 2: Отрисовка и визуализация

Цель: Реализовать корректное отображение виджетов на Konva канвасе.

#### Задача 2.1: Реализовать рендеринг виджетов
**Статус**: ПЛАНИРОВАНИЕ
**Файлы**:
- `public/widget.js` - методы рендеринга
- `public/widget-renderer.js` - утилиты рендеринга (ВОЗМОЖНО СОЗДАТЬ)

**Подзадачи**:
- [ ] Реализовать базовый Konva.Shape для виджета
- [ ] Добавить CSS-подобные стили (border, background)
- [ ] Реализовать текстовый слой
- [ ] Добавить иконки для типов (info/warning/error)
- [ ] Реализовать анимацию появления

**Требования**:
- Используются только Konva примитивы (Rect, Text, Image)
- Следование мышке опционально
- Масштабирование вместе с изображением

---

#### Задача 2.2: Система позиционирования
**Статус**: ПЛАНИРОВАНИЕ
**Файлы**:
- `public/widget-position-calculator.js` - расчёт позиций (СОЗДАТЬ)
- `public/widget.js` - использование калькулятора

**Подзадачи**:
- [ ] Реализовать привязку к точке соединения
- [ ] Реализовать привязку к стороне изображения
- [ ] Реализовать смещение относительно привязки
- [ ] Добавить проверку выхода за границы
- [ ] Реализовать автоматический перемещение если выходит

**Требования**:
- Позиции рассчитываются в 2D пространстве stage
- Учитывается масштаб stage
- Обновление происходит каждый раз при движении хозяина

---

### ЭТАП 3: Интеграция и тестирование

Цель: Убедиться что система работает со всеми другими компонентами.

#### Задача 3.1: Интеграция с ImageManager
**Статус**: ПЛАНИРОВАНИЕ
**Файлы**:
- `public/image-manager.js` - добавить события о движении/ресайзе
- `public/ui-controller.js` - установить callbacks
- `public/widget-manager.js` - слушать события

**Подзадачи**:
- [ ] Добавить событие `onImageMove` в ImageManager
- [ ] Добавить событие `onImageResize` в ImageManager
- [ ] Интегрировать WidgetManager в setupManagerCallbacks()
- [ ] Проверить что виджеты обновляются при движении
- [ ] Проверить что виджеты обновляются при ресайзе

**Требования**:
- Синхронизация должна быть в реальном времени
- Не должно быть задержек при движении
- Не должно быть утечек памяти

---

#### Задача 3.2: Интеграция с FileManager
**Статус**: ПЛАНИРОВАНИЕ
**Файлы**:
- `public/file-manager.js` - сохранение/загрузка виджетов
- `public/widget-manager.js` - экспорт/импорт

**Подзадачи**:
- [ ] Добавить сохранение виджетов при save
- [ ] Добавить загрузку виджетов при load
- [ ] Реализовать сериализацию Widget
- [ ] Реализовать десериализацию Widget
- [ ] Проверить что виджеты восстанавливаются

**Требования**:
- Формат сохранения: JSON
- Структура: массив объектов с конфигом каждого виджета
- Должны сохраняться: тип, содержимое, привязка, позиция

---

#### Задача 3.3: Дебаг и оптимизация
**Статус**: ПЛАНИРОВАНИЕ
**Файлы**:
- Все файлы виджетов
- `public/debug-widgets.js` - утилиты отладки (ВОЗМОЖНО СОЗДАТЬ)

**Подзадачи**:
- [ ] Добавить логирование ключевых событий
- [ ] Добавить проверки граничных случаев
- [ ] Оптимизировать производительность при 50+ виджетах
- [ ] Проверить утечки памяти при добавлении/удалении
- [ ] Протестировать все type комбинации

**Требования**:
- 50+ виджетов должны обновляться плавно (60fps)
- Нет утечек памяти при удалении
- Коректная работа при zoom/pan

---

### ЭТАП 4: Функциональность редактирования

Цель: Добавить возможность редактирования виджетов в UI.

#### Задача 4.1: Панель свойств для виджетов
**Статус**: ПЛАНИРОВАНИЕ
**Файлы**:
- `public/properties-panel.js` - добавить UI для виджетов
- `public/widget-manager.js` - выбор виджета

**Подзадачи**:
- [ ] Добавить выделение виджета при клике
- [ ] Добавить отображение свойств в панели
- [ ] Реализовать редактирование типа
- [ ] Реализовать редактирование содержимого
- [ ] Реализовать удаление виджета

**Требования**:
- Один виджет может быть выбран одновременно
- Изменения должны применяться в реальном времени
- Должна быть кнопка удаления

---

#### Задача 4.2: Добавление виджетов через UI
**Статус**: ПЛАНИРОВАНИЕ
**Файлы**:
- `index.html` - добавить кнопку
- `public/ui-controller.js` - обработчик
- `public/widget-manager.js` - создание

**Подзадачи**:
- [ ] Добавить кнопку "Добавить виджет"
- [ ] Реализовать диалог создания виджета
- [ ] Реализовать выбор типа и содержимого
- [ ] Интегрировать с WidgetManager
- [ ] Проверить работу создания

**Требования**:
- Диалог должен быть интуитивным
- По умолчанию привязываться к последнему выбранному объекту
- Виджет должен появиться сразу после создания

---

## ЗАВИСИМОСТИ

```
Этап 1.1 (Race condition) ✓ ЗАВЕРШЕНО
    ↓
Этап 1.2 (WidgetManager)
    ↓
Этап 1.3 (Widget)
    ↓
Этап 2.1 (Рендеринг)
    ↓
Этап 2.2 (Позиционирование)
    ↓
Этап 3.1 (Интеграция ImageManager) ←── ПАРАЛЛЕЛЬНО 2.1 и 2.2
    ↓
Этап 3.2 (Интеграция FileManager)
    ↓
Этап 3.3 (Дебаг и оптимизация)
    ↓
Этап 4.1 (Панель свойств) ←── ОПЦИОНАЛЬНО
    ↓
Этап 4.2 (UI добавления) ←── ОПЦИОНАЛЬНО
```

---

## ВРЕМЕННАЯ ШКАЛА

| Этап | Задача | Статус | Дни | Дата начала | Дата конца |
|------|--------|--------|-----|------------|----------|
| 1 | 1.1 Race condition | ✓ DONE | 1 | 2026-01-24 | 2026-01-26 |
| 1 | 1.2 WidgetManager | TODO | 2 | 2026-01-26 | 2026-01-27 |
| 1 | 1.3 Widget | TODO | 2 | 2026-01-27 | 2026-01-28 |
| 2 | 2.1 Рендеринг | TODO | 2 | 2026-01-28 | 2026-01-29 |
| 2 | 2.2 Позиционирование | TODO | 2 | 2026-01-29 | 2026-01-30 |
| 3 | 3.1 ImageManager | TODO | 1 | 2026-01-30 | 2026-01-31 |
| 3 | 3.2 FileManager | TODO | 1 | 2026-01-31 | 2026-02-01 |
| 3 | 3.3 Дебаг | TODO | 2 | 2026-02-01 | 2026-02-03 |
| 4 | 4.1 Панель свойств | TODO | 1 | 2026-02-03 | 2026-02-04 |
| 4 | 4.2 UI добавления | TODO | 1 | 2026-02-04 | 2026-02-05 |
| - | Буферное время | - | 2 | 2026-02-05 | 2026-02-07 |

**Итого**: ~14 дней с буфером

---

## ФАЙЛЫ К СОЗДАНИЮ/ИЗМЕНЕНИЮ

### Создание
- [ ] `public/widget-manager.js` - основной менеджер виджетов
- [ ] `public/widget.js` - класс отдельного виджета
- [ ] `public/widget-position-calculator.js` - расчёт позиций (опционально)
- [ ] `public/widget-renderer.js` - утилиты рендеринга (опционально)
- [ ] `public/debug-widgets.js` - утилиты отладки (опционально)

### Изменение
- [x] `public/canvas-manager.js` - DONE (1.1)
- [x] `public/ui-controller.js` - DONE (1.1)
- [ ] `public/image-manager.js` - добавить события
- [ ] `public/file-manager.js` - сохранение/загрузка
- [ ] `public/properties-panel.js` - UI для виджетов
- [ ] `index.html` - кнопка добавления

---

## КРИТЕРИИ ЗАВЕРШЕНИЯ

### Минимум (Phase 1 Display)
- [x] Инициализация работает без race condition
- [ ] WidgetManager корректно управляет виджетами
- [ ] Widget отображается на канвасе
- [ ] Позиции синхронизируются с изображениями
- [ ] Обновления при ресайзе работают
- [ ] Нет консольных ошибок

### Дополнительно (Nice to have)
- [ ] Панель свойств для редактирования
- [ ] UI добавления новых виджетов
- [ ] Сохранение/загрузка виджетов
- [ ] Анимации и эффекты

---

## КОМАНДНЫЕ ЗАДАЧИ

1. **Коммиты при завершении каждой задачи**
   ```
   feat: implement WidgetManager core functionality (задача 1.2)
   feat: implement Widget class (задача 1.3)
   feat: implement widget rendering (задача 2.1)
   ...
   ```

2. **Сверка с планом перед каждым запросом**
   - Проверить что текущая задача включена в план
   - Обновить статус перед стартом
   - Указать номер задачи в комментариях

3. **Еженедельный review**
   - Проверка прогресса
   - Корректировка временной шкалы
   - Обновление плана если требуется

---

## ПРИМЕЧАНИЯ

- План может меняться в зависимости от открытых проблем
- Приоритет: Этап 1 и 2 критичны, Этап 4 опционален
- Требуется регулярное тестирование на каждом этапе
- Документация обновляется параллельно с разработкой

---

## ИСТОРИЯ ИЗМЕНЕНИЙ

| Версия | Дата | Изменение |
|--------|------|----------|
| 1.0 | 2026-01-26 | Первая версия плана |
