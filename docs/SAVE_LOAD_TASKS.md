# Лист задач: Имплементация Save/Load схем с Base64

**Версия**: 1.0  
**Дата**: 30.01.2026  
**Статус**: Не начато

---

## ФАЗА 1: Проверка и текущая реализация

### Время оценка: 1 час

#### Таск 1.1: Анализ текущего кода

- [ ] **Открыть файл `public/file-manager.js`**
  - Исследуем текущую реализацию
  - Найти методы `saveScheme()` и `loadScheme()`
  - Понять экспорт/импорт изображений
  - Что сейчас сохраняется (только URL? или полные данные?)

- [ ] **Открыть файл `public/image-manager.js`**
  - Найти метод `exportImages()`
  - Проанализировать структуру экспортируемых данных
  - Найти метод `importImages()`
  - Понять, как сейчас гружаются изображения
  - Объекты `this.images` - какая структура?

- [ ] **Понять текущие отсылки (если есть)**
  - [ ] Когда сохраняются изображения, как это работает?
  - [ ] Нормально ли сохраняются только URL или полные данные?
  - [ ] При загрузке теряются ли изображения?

#### Таск 1.2: Проверка кнопок в UI

- [ ] **Проверить работу кнопки "Сохранить"**
  - [ ] Найти кнопку в `public/index.html`
  - [ ] Клик запускает `saveScheme()`?
  - [ ] Скачивается JSON файл?
  - [ ] Настроики алертов/сообщений?

- [ ] **Проверить работу кнопки "Загрузить"**
  - [ ] Найти кнопку в `public/index.html`
  - [ ] Клик открывает диалог выбора файла?
  - [ ] Выбор файла триггерит `loadScheme()`?
  - [ ] Настроики алертов/ошибок?

#### Таск 1.3: Проверка консоли

- [ ] **Открыть DevTools > Console**
  - [ ] При сохранении схемы с изображениями
  - [ ] При загрузке сохраненной схемы
  - [ ] Хоть какие-нибудь ошибки в console?

---

## ФАЗА 2: Новые методы ImageManager

### Время оценка: 1.5 часа

#### Таск 2.1: Новый метод `imageToBase64()`

```javascript
// В классе ImageManager добавить:
imageToBase64(konvaImage) {
    try {
        return konvaImage.toDataURL();
    } catch(e) {
        console.error('Ошибка при конвертации в Base64:', e);
        return null;
    }
}
```

- [ ] **Написан метод `imageToBase64()`**
  - [ ] Овывает `konvaImage.toDataURL()`
  - [ ] Обрабатывает ошибки
  - [ ] Возвращает Base64 строку (`data:image/png;base64,...`)
  - [ ] Элементарное тестирование - строка непустая?

#### Таск 2.2: Обновление `exportImages()` для Base64

- [ ] **Цель: экспорт Base64 вместо URL**
  - [ ] Все объекты с `data` в аррею результата
  - [ ] `data` содержит Base64 строку
  - [ ] Прючие внсй поля (жирны, высота, x, y, scale) остаются
  - [ ] Точная структура данных:
    ```javascript
    {
        id: "img1",
        name: "image.png",
        data: "data:image/png;base64,iVBORw0KGgo...",
        width: 800,
        height: 600,
        x: 100,
        y: 50,
        scaleX: 1,
        scaleY: 1
    }
    ```

- [ ] **Определю для асинхронности**
  - [ ] Метод `async exportImages()`
  - [ ] Используют `Promise.all()` для быстроты

- [ ] **Тестирование `exportImages()`**
  - [ ] Удалить 2-3 изображения на canvas
  - [ ] `console.log(await imageManager.exportImages())`
  - [ ] Вывод: array с объектами, где `data` = Base64

#### Таск 2.3: Обновление `importImages()` гружать из Base64

- [ ] **Перенаписать `importImages()` для Base64**
  - [ ] Шаг 1: На объект в аррею `imagesData`
  - [ ] Шаг 2: Создать `new Image()`
  - [ ] Шаг 3: Установить `img.src = data.data` (бут Base64!)
  - [ ] Шаг 4: Когда `img.onload`→ вызвать `addImage()`

- [ ] **Тестирование**
  - [ ] дюКод на включение обработки ошибок

---

## ФАЗА 3: Обновление FileManager

### Время оценка: 1 час

#### Таск 3.1: Обновление `saveScheme()` асинхронно

- [ ] **Сделать `saveScheme()` асинхронным**
  - [ ] `async saveScheme()`
  - [ ] Внутри используем `await this.imageManager.exportImages()`
  - [ ] Включить вырезку Base64 данных в JSON

```javascript
async saveScheme() {
    try {
        const scheme = {
            version: '1.0',
            timestamp: new Date().toISOString(),
            images: await this.imageManager.exportImages(),  // ← Base64!
            connectionPoints: this.connectionPointManager.exportPoints(),
            connections: this.connectionManager.exportConnections(),
            widgets: this.widgetManager?.exportWidgets() || []
        };
        
        this.downloadJSON(JSON.stringify(scheme, null, 2), 'scheme.json');
        alert('Схема успешно сохранена!');
    } catch(e) {
        console.error('Ошибка при сохранении:', e);
        alert('Ошибка при сохранении схемы');
    }
}
```

- [ ] **Тестирование**
  - [ ] Нарисовать схему с 2-3 изображениями
  - [ ] Нажать "Сохранить"
  - [ ] Скачивается JSON
  - [ ] Открыть JSON в текстовом редакторе
  - [ ] Видны Base64 строки в `images[].data`

#### Таск 3.2: Обновление `loadScheme()` восстанавливала изображения

```javascript
loadScheme(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const scheme = JSON.parse(e.target.result);
            
            // Очистить всё
            this.clearAll();
            
            // Загрузить все компоненты
            this.imageManager.importImages(scheme.images || []);  // ← Base64 восстанавливала!
            this.connectionPointManager.importPoints(scheme.connectionPoints || []);
            this.connectionManager.importConnections(scheme.connections || []);
            this.widgetManager?.importWidgets(scheme.widgets || []);
            
            alert('Схема успешно загружена!');
        } catch(e) {
            console.error('Ошибка при загружке:', e);
            alert('Ошибка: ' + e.message);
        }
    };
    reader.readAsText(file);
}
```

- [ ] **Критические черные точки**
  - [ ] `try-catch` для распарсивания JSON
  - [ ] ОЧИСТИТЬ (КОМЕНТАРИЙ!) canvas твердю перед загружкой
  - [ ] Проверка корректных восстановления всех компонентов

- [ ] **Тестирование**
  - [ ] Вставить сохраненный JSON
  - [ ] Кнопка "Загрузить"
  - [ ] Выбрать файл
  - [ ] Появляются изображения?
  - [ ] Положение и масштаб верные?
  - [ ] Качество изображения не понижено?

---

## ФАЗА 4: Общее тестирование

### Время оценка: 1 час

#### Таск 4.1: Функциональное тестирование

- [ ] **Сценарий 1: Полная схема**
  - [ ] Добавить 3 изображения на canvas
  - [ ] Выставить соединения между ними
  - [ ] Начертить несколько соединительных точек
  - [ ] Нажать "Сохранить"
  - [ ] Проверить, что JSON сних действительно скачалось
  - [ ] Надать кнопку "Очистить"
  - [ ] Нажать "Загрузить"→ выбрать JSON
  - [ ] Появляются 3 изображения с тем же расположением?
  - [ ] Появляются соединения?
  - [ ] Появляются точки?

- [ ] **Сценарий 2: Пустая схема**
  - [ ] Не добавлять изображения
  - [ ] Нажать "Сохранить"
  - [ ] Корректно сохраняется? (пустые arrays)
  - [ ] Загружается без ошибок?

- [ ] **Сценарий 3: Много изображений**
  - [ ] Добавить 10+ изображений
  - [ ] Проверить быстродействие сохранения (< 2 сек)
  - [ ] Проверить размер JSON файла (~33% больше)
  - [ ] Загружение нормальное (< 2 сек)

#### Таск 4.2: Ошибки и граничные случаи

- [ ] **Арыв выбора JSON**
  - [ ] Выбрать текстовый файл вместо JSON
  - [ ] Ошибка в alert и console

- [ ] **Поврежденный JSON**
  - [ ] Открыть JSON в редакторе
  - [ ] Поменять рандомные символы в Base64 строке
  - [ ] Похранить
  - [ ] Гружить - ошибка появляетсяОфы?

- [ ] **Пустая Base64 строка**
  - [ ] Мануально истлить JSON без изображений
  - [ ] Гружить - нормально работает?

#### Таск 4.3: Console очистка

- [ ] **Нет ошибок в DevTools > Console**
  - [ ] При сохранении
  - [ ] При загружке
  - [ ] Нет снижных warning'ов

---

## РЕЗУЛЬТАТЫВАЯ ПОЛВЕРКА ОКОНЧАНИЯ

### Обязательные критерии

- [ ] `imageManager.exportImages()` асинхронная и вернует Base64
- [ ] `imageManager.importImages()` работает с Base64
- [ ] `fileManager.saveScheme()` сохраняет Base64 в JSON
- [ ] `fileManager.loadScheme()` восстанавливает из Base64
- [ ] Кнопки "Сохранить" и "Загрузить" работают
- [ ] Нет JS ошибок в console
- [ ] 100% изображения восстанавливаются с тем же качеством

### Оптимальные критерии

- [ ] Время сохранения < 2 сек (для 10MB)
- [ ] Полезные сообщения о статусе
- [ ] Валидация JSON при загружке
- [ ] Никаких browser storage апи (только JSON)

---

## ПОМОЩНИКИ И ОТРАВКА

### Нанизания для дебага

**Добавить в console для проверки:**

```javascript
// Проверить экспорт
 imageManager.exportImages().then(data => {
    console.log('На сколько базе 64:', data.length);
    console.log('Первые 100 символов:', data[0].data?.substring(0, 100));
});

// Проверить размер JSON
const scheme = {...};
console.log('Размер JSON:', JSON.stringify(scheme).length / 1024 + ' KB');
```

### Ресурсы

- документация: `docs/BASE64_EXPLANATION.md`, `docs/BASE64_QUICK_REFERENCE.md`
- Литература: Konva.js `toDataURL()` - документация
- Мдн: https://developer.mozilla.org/en-US/docs/Web/API/Canvas/toDataURL

---

## Примечания

- Асинхронность CRITICAL в `exportImages()` - не ноблюдать часо главном тредадом
- Тестировать с DIFFERENT IMAGES разных размеров, типов
- Оригинальные тесты для ограничения (до 10MB per schema, not per image)

---

**ОСНОВНОЕ**: НАПШЕ ТЕРПОРНОСТИ - ВСЕ ОтМЕЧЕНО СТАВиТСя ОТМеты
